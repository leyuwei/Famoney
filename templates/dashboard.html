{{define "content"}}
<h2>{{T "Dashboard"}}</h2>
<h5>{{T "TotalBalance"}}: {{FormatMoney .TotalBalance}} {{.BaseCurrency}}</h5>

<div class="row mb-4">
  <div class="col-md-6">
    <h5>{{T "ByCurrency"}}</h5>
    <ul class="list-group">
      {{range $cur, $bal := .CurrencyTotals}}
      <li class="list-group-item d-flex justify-content-between align-items-center">{{$cur}}<span>{{FormatMoney $bal}}</span></li>
      {{else}}
      <li class="list-group-item">{{T "NoWallets"}}</li>
      {{end}}
    </ul>
  </div>
  <div class="col-md-6">
    <h5>{{T "ByCategory"}}</h5>
    <ul class="list-group">
      {{range $cid, $bal := .CategoryTotals}}
      <li class="list-group-item d-flex justify-content-between align-items-center category-item" data-cid="{{$cid}}" data-name="{{(index $.CategoriesMap $cid).Name}}">{{(index $.CategoriesMap $cid).Name}}<span>{{FormatMoney $bal}}</span></li>
      {{else}}
      <li class="list-group-item">{{T "NoFlows"}}</li>
      {{end}}
    </ul>
  </div>
</div>

<div class="mb-3">
  <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#createWalletModal">{{T "CreateWallet"}}</button>
  <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#viewCategoriesModal">{{T "ViewCategories"}}</button>
</div>

<div class="row" id="walletList">
{{range .Wallets}}
  <div class="col-md-4 mb-3 wallet-item" data-id="{{.ID}}">
    <div class="wallet-card" style="{{if .Color}}background: {{.Color}};{{end}}">
      <h4 class="card-title">{{.Name}}</h4>
      {{range $cur, $bal := .Balances}}
      <p class="card-text">{{T "Balance"}}: {{FormatMoney $bal}} {{$cur}} (~{{FormatMoney (Convert $bal $cur $.BaseCurrency)}} {{$.BaseCurrency}})</p>
      {{end}}
      <a href="/famoney/wallet/{{.ID}}" class="btn btn-light btn-sm">{{T "View"}}</a>
    </div>
  </div>
{{else}}
  <p>{{T "NoWallets"}}</p>
{{end}}
</div>

<div class="modal fade" id="createWalletModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="/famoney/wallet/create" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{T "CreateWallet"}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{T "Close"}}"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3"><input class="form-control" name="name" placeholder="{{T "WalletName"}}"></div>
        <div class="mb-3">
          <select class="form-select" name="currency">
            {{range .Currencies}}<option value="{{.}}">{{.}}</option>{{end}}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">{{T "Color"}}</label>
          <input type="color" class="form-control form-control-color" name="color" value="#b5651d">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{T "Close"}}</button>
        <button type="submit" class="btn btn-success">{{T "Add"}}</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="viewCategoriesModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{T "ViewCategories"}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{T "Close"}}"></button>
      </div>
      <div class="modal-body">
        {{if .CategoryInUse}}
        <div class="alert alert-warning">{{T "CategoryInUse"}}</div>
        {{end}}
        <form method="POST" action="/famoney/category/add" class="input-group mb-3">
          <input class="form-control" name="name" placeholder="{{T "Category"}}">
          <button class="btn btn-success" type="submit">{{T "Add"}}</button>
        </form>
        {{range .Categories}}
        <form method="POST" action="/famoney/category/update" class="input-group mb-2">
          <input type="hidden" name="id" value="{{.ID}}">
          <input class="form-control" name="name" value="{{.Name}}">
          <button class="btn btn-primary" type="submit">{{T "Edit"}}</button>
          <button class="btn btn-danger" type="submit" formaction="/famoney/category/delete" onclick="return confirm('{{T "Confirm"}}');">{{T "Delete"}}</button>
        </form>
        {{end}}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{T "Close"}}</button>
      </div>
    </div>
</div>
</div>

<div class="modal fade" id="categoryDetailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryDetailModalLabel">{{T "CategoryDetails"}}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{T "Close"}}"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="categoryDetailList"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{T "Close"}}</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var list = document.getElementById('walletList');
  if (list) {
    new Sortable(list, {
      animation: 150,
      onEnd: function() {
        var ids = [];
        document.querySelectorAll('#walletList .wallet-item').forEach(function(el){
          ids.push(parseInt(el.dataset.id));
        });
        fetch('/famoney/wallet/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({order: ids})
        });
      }
    });
  }
});

var categoryData = {{ToJSON .CategoryWallets}};
var baseCurrency = '{{.BaseCurrency}}';
function formatMoney(num) {
  return num.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}
document.querySelectorAll('.category-item').forEach(function(el){
  el.addEventListener('click', function(){
    var cid = this.dataset.cid;
    var name = this.dataset.name;
    var list = document.getElementById('categoryDetailList');
    list.innerHTML = '';
    var data = categoryData[cid] || {};
    for (var w in data) {
      var li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = w + '<span>' + formatMoney(data[w]) + ' ' + baseCurrency + '</span>';
      list.appendChild(li);
    }
    if (!list.children.length) {
      var li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = '{{T "NoFlows"}}';
      list.appendChild(li);
    }
    document.getElementById('categoryDetailModalLabel').textContent = name;
    var m = new bootstrap.Modal(document.getElementById('categoryDetailModal'));
    m.show();
  });
});
</script>

{{if .CategoryInUse}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  var m = new bootstrap.Modal(document.getElementById('viewCategoriesModal'));
  m.show();
});
</script>
{{end}}

{{end}}
